<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All datasets - OpenGWAS</title>
  <link rel="shortcut icon" type="image/png" sizes="32x32" href="../images/logo/opengwas/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css" integrity="sha512-fw7f+TcMjTb7bpbLJZlP8g2Y4XcCyFZW8uy8HsRZsH/SwbMw0plKHFHr99DN3l04VsYNwvzicUX/6qurvIxbxw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css" integrity="sha512-t7Few9xlddEmgd3oKZQahkNI4dS6l80+eGEzFQiqtyVYdvcSG2D3Iub77R20BdotfRPA9caaRkg1tyaJiPmO0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-2.3.2/b-3.2.4/b-html5-3.2.4/datatables.min.css" rel="stylesheet" integrity="sha384-da1RzZN/J6BPsPORWFErAk8mFOaYQkGbWJeiVnME5UhVhp5v/SwUha/qcgYTjAPJ" crossorigin="anonymous">
  <style>
    .wrap-text {
      white-space: normal !important;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div id="header"></div>

  <main class="container mt-3" style="max-width: 1000px">
    <h3>Datasets</h3>

    <div class="progress" role="progressbar" aria-label="Loading in progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      <div id="progress" class="progress-bar progress-bar-animated" id="progress" style="width: 0%">0%</div>
    </div>

    <div class="d-flex align-items-center">
      <span id="notes"></span>
      <a class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBatches" aria-expanded="false" aria-controls="collapseBatches">
        Show or hide batches
      </a>
    </div>

    <div class="collapse" id="collapseBatches">
      <div class="card card-body" style="height: 400px; overflow-y: auto;">
        <table class="display table table-striped table-sm" style="width: 100%;">
          <thead>
            <tr>
              <th width="15%">ID starting with</th>
              <th width="10%">Datasets</th>
              <th>Description</th>
              <th width="10%">Link</th>
            </tr>
          </thead>
          <tbody id="batchesTableBody"></tbody>
        </table>  
      </div>
    </div>

    <table id="gwasTable" class="display table table-striped table-sm" style="width: 100%;">
      <thead>
        <tr>
          <th>OpenGWAS ID</th>
          <th>Trait</th>
          <th>Year</th>
          <th>Author</th>
          <th>Consortium</th>
          <th>Sample Size</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="footer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.bundle.min.js" integrity="sha512-Tc0i+vRogmX4NN7tuLbQfBxa8JkfUSAxSFVzmU31nVdHyiHElPPy2cWfFacmCJKw0VqovrzKhdd2TSTMdAxp2g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-2.3.2/b-3.2.4/b-html5-3.2.4/datatables.min.js" integrity="sha384-cTeXLnfaSbI/49ovkPyA4Ux8hZn9H8GdEQme7QVQcJl1b6vwvbEJ0szdHcs5W0He" crossorigin="anonymous"></script>
  <script type="module">
    import { includeHTML } from '../js/include.js';
    import { loadData } from '../js/gwas-storage.js';
    import { parseUnicodeString } from '../js/utils.js';

    includeHTML('#header', '/common/header.html');
    includeHTML('#footer', '/common/footer.html', () => {
      document.getElementById('footerYear').textContent = new Date().getFullYear();
    });

    const isProduction = ['opengwas.io'].includes(window.location.hostname);

    function extractTableData(compressedData) {
      const keys = Object.keys(compressedData);
      const fields = ['trait', 'year', 'author', 'consortium', 'sample_size'];
      const fieldIndex = {
        trait: 0,
        year: 7,
        author: 6,
        consortium: 11,
        sample_size: 10,
      };
      return keys.map(id => {
        const arr = compressedData[id][0];
        return [
          id,
          arr[fieldIndex.trait],
          arr[fieldIndex.year],
          parseUnicodeString(arr[fieldIndex.author]),
          arr[fieldIndex.consortium],
          arr[fieldIndex.sample_size],
        ];
      }).sort(() => Math.random() - 0.5);
    }

    function populateGwasTable(tableData) {
      $('#gwasTable').DataTable({
        data: tableData,
        columnDefs: [
          {
            targets: 0,
            width: '130px',
            className: 'wrap-text',
            render : (data, type, row) => {
              const href = isProduction ? `/datasets/${data}` : `/datasets/dataset.html?id=${data}`;
              return `<a href="${href}" target="_blank">${data}</a>`;
            }
          },
          {
            targets: 1,
            width: '300px',
            className: 'wrap-text',
          },
          {
            targets: 3,
            width: '150px',
            className: 'wrap-text',
          },
          {
            targets: 4,
            width: '110px',
            className: 'wrap-text',
          },
        ],
        pageLength: 25,
        scrollX: true,
        order: [],
        layout: {
            topStart: 'search',
            topEnd: {
              buttons: [{
                extend: 'csv',
                text: 'Export current results CSV',
                className: 'btn btn-sm btn-light',
              }]
            },
            bottomStart: 'info',
            bottomEnd: 'paging'
        },
        language: {
          lengthMenu: "Show _MENU_ datasets",
          info: "Showing _START_ to _END_ of _TOTAL_ datasets",
          infoFiltered: "(filtered from _MAX_ total datasets)",
          infoEmpty: "Showing 0 to 0 of 0 datasets",
          zeroRecords: "No matching datasets found",
        },
      });
    }

    function populateBatchesTable(batches) {
      const tbody = document.getElementById('batchesTableBody');
      tbody.innerHTML = '';

      batches.forEach(batch => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td><a href="#" class="batch-filter-link" data-id="${batch.id}">${batch.id}</a></td>
          <td>${batch.count.toLocaleString()}</td>
          <td>${batch.description}</td>
          <td><a href="${batch.link}" target="_blank"><i class="bi bi-box-arrow-up-right"></i></a></td>
        `;

        tbody.appendChild(row);
      });

      tbody.querySelectorAll('.batch-filter-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const id = e.target.dataset.id;
          const table = $('#gwasTable').DataTable();
          table.search(id).draw();
        });
      });
    }

    const progressBar = document.getElementById('progress');
    const notes = document.getElementById('notes');

    loadData('gwasinfo', progress => {
      progressBar.style.width = `${progress}%`;
      progressBar.setAttribute('aria-valuenow', progress);
      progressBar.textContent = `${progress}%`;
    }).then(gwasinfo => {
      const tableData = extractTableData(gwasinfo['datasets_compressed']);
      notes.innerHTML = `Listing ${gwasinfo['metadata']['size'].toLocaleString()} datasets updated at ${gwasinfo['metadata']['updated_at']}. Displayed in random order.`
      progressBar.parentElement.style.display = 'none';
      populateGwasTable(tableData);
    }).catch(err => {
      progressBar.classList.add('bg-danger');
      progressBar.style.width = '100%';
      progressBar.textContent = 'Failed to load data';
    });

    loadData('batches').then(batches => {
      populateBatchesTable(batches);
    }).catch(err => {
      document.getElementById('batchesTableBody').innerHTML = `
        <tr><td colspan="4" class="text-danger">Failed to load batches data.</td></tr>
      `;
    });

  </script>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "sq9z63te1u");
  </script>

</body>
</html>
